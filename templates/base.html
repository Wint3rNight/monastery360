{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'en' }}" dir="ltr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="robots" content="index, follow">
    <meta name="author" content="Monastery360">

    <!-- Page Title and Description -->
    <title>{% block title %}{{ page_title|default:"Monastery360 - Digital Heritage of Sikkim's Monasteries" }}{% endblock %}</title>
    <meta name="description" content="{% block description %}{{ page_description|default:'Explore the rich heritage of Buddhist monasteries in Sikkim through virtual tours, digital archives, and cultural experiences.' }}{% endblock %}">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="{% block og_title %}{{ page_title|default:"Monastery360" }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ page_description|default:'Digital heritage platform for Sikkim Buddhist monasteries' }}{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{% load static %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/monastery360-og.jpg' %}{% endblock %}">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ request.build_absolute_uri }}">
    <meta property="twitter:title" content="{% block twitter_title %}{{ page_title|default:"Monastery360" }}{% endblock %}">
    <meta property="twitter:description" content="{% block twitter_description %}{{ page_description|default:'Digital heritage platform for Sikkim Buddhist monasteries' }}{% endblock %}">
    <meta property="twitter:image" content="{% block twitter_image %}{% load static %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/monastery360-og.jpg' %}{% endblock %}">

    <!-- Canonical URL -->
    <link rel="canonical" href="{% block canonical %}{{ request.build_absolute_uri }}{% endblock %}">

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon-16x16.png' %}">

    <!-- PWA Manifest -->
    <link rel="manifest" href="{% url 'manifest' %}">
    <meta name="theme-color" content="#8B4513">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Monastery360">

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- CSS Libraries -->
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUa6C2+0+p4aAJsJwvVk40yXY+1nF/UdGaA4m9O0PQQ5yA5EYmwl7j1p7j1p" crossorigin="anonymous">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">

    <!-- Pannellum CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">

    <!-- Additional CSS -->
    {% block extra_css %}{% endblock %}

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- JSON-LD Structured Data -->
    {% block structured_data %}
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Monastery360",
        "description": "Digital heritage platform for Buddhist monasteries in Sikkim",
        "url": "{{ request.scheme }}://{{ request.get_host }}",
        "sameAs": [
            "https://twitter.com/monastery360",
            "https://facebook.com/monastery360"
        ],
        "potentialAction": {
            "@type": "SearchAction",
            "target": "{{ request.scheme }}://{{ request.get_host }}{% url 'core:search' %}?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    {% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-link visually-hidden-focusable">Skip to main content</a>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top" role="navigation" aria-label="Main navigation">
        <div class="container">
            <!-- Brand -->
            <a class="navbar-brand d-flex align-items-center" href="{% url 'core:home' %}" aria-label="Monastery360 Home">
                <i class="fas fa-dharmachakra me-2" aria-hidden="true"></i>
                <span>Monastery360</span>
            </a>

            <!-- Mobile toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navigation items -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'core:home' %}">
                            <i class="fas fa-home me-1" aria-hidden="true"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'core:monastery_list' %}">
                            <i class="fas fa-temple me-1" aria-hidden="true"></i>Monasteries
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'tours:panorama_list' %}">
                            <i class="fas fa-vr-cardboard me-1" aria-hidden="true"></i>Virtual Tours
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'archives:digital_portal' %}">
                            <i class="fas fa-archive me-1" aria-hidden="true"></i>Digital Archives
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'events:calendar' %}">
                            <i class="fas fa-calendar me-1" aria-hidden="true"></i>Events
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'core:monastery_map' %}">
                            <i class="fas fa-map me-1" aria-hidden="true"></i>Map
                        </a>
                    </li>
                </ul>

                <!-- Search form -->
                <form class="d-flex me-3" method="get" action="{% url 'core:search' %}" role="search">
                    <div class="input-group">
                        <input class="form-control form-control-sm" type="search" name="q"
                               placeholder="Search..." aria-label="Search" value="{{ request.GET.q }}">
                        <button class="btn btn-outline-light btn-sm" type="submit" aria-label="Submit search">
                            <i class="fas fa-search" aria-hidden="true"></i>
                        </button>
                    </div>
                </form>

                <!-- Language switcher with Google Translate -->
                <div class="dropdown me-2">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button"
                            id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Select language">
                        <i class="fas fa-globe me-1" aria-hidden="true"></i>
                        <span id="current-language">English</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
                        <li>
                            <button class="dropdown-item language-option" data-lang="en" data-name="English">
                                <i class="fas fa-flag me-2" aria-hidden="true"></i>English
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item language-option" data-lang="hi" data-name="हिन्दी">
                                <i class="fas fa-flag me-2" aria-hidden="true"></i>हिन्दी (Hindi)
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item language-option" data-lang="ne" data-name="नेपाली">
                                <i class="fas fa-flag me-2" aria-hidden="true"></i>नेपाली (Nepali)
                            </button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <button class="dropdown-item" id="reset-translation">
                                <i class="fas fa-undo me-2" aria-hidden="true"></i>Reset to Original
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Book visit button -->
                <a href="{% url 'bookings:form' %}" class="btn btn-warning btn-sm ms-2">
                    <i class="fas fa-calendar-plus me-1" aria-hidden="true"></i>Book Visit
                </a>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <main id="main-content" class="{% block main_class %}{% endblock %}">
        <!-- Messages -->
        {% if messages %}
            <div class="container mt-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {% if message.tags == 'error' %}
                            <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>
                        {% elif message.tags == 'warning' %}
                            <i class="fas fa-exclamation-circle me-2" aria-hidden="true"></i>
                        {% elif message.tags == 'success' %}
                            <i class="fas fa-check-circle me-2" aria-hidden="true"></i>
                        {% elif message.tags == 'info' %}
                            <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Page content -->
        {% block content %}
        {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-5 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-dharmachakra me-2" aria-hidden="true"></i>
                        Monastery360
                    </h5>
                    <p class="text-muted">
                        Preserving and sharing the rich Buddhist heritage of Sikkim's monasteries through digital innovation.
                    </p>
                    <div class="social-links">
                        <a href="#" class="text-light me-3" aria-label="Facebook"><i class="fab fa-facebook" aria-hidden="true"></i></a>
                        <a href="#" class="text-light me-3" aria-label="Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a>
                        <a href="#" class="text-light me-3" aria-label="Instagram"><i class="fab fa-instagram" aria-hidden="true"></i></a>
                        <a href="#" class="text-light" aria-label="YouTube"><i class="fab fa-youtube" aria-hidden="true"></i></a>
                    </div>
                </div>

                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="mb-3">Explore</h6>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'core:monastery_list' %}" class="text-muted text-decoration-none">Monasteries</a></li>
                        <li><a href="{% url 'tours:panorama_list' %}" class="text-muted text-decoration-none">Virtual Tours</a></li>
                        <li><a href="{% url 'archives:digital_portal' %}" class="text-muted text-decoration-none">Digital Archives</a></li>
                        <li><a href="{% url 'events:calendar' %}" class="text-muted text-decoration-none">Events</a></li>
                        <li><a href="{% url 'core:monastery_map' %}" class="text-muted text-decoration-none">Map</a></li>
                    </ul>
                </div>

                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="mb-3">Services</h6>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'bookings:form' %}" class="text-muted text-decoration-none">Book Visit</a></li>
                        <li><a href="{% url 'bookings:search' %}" class="text-muted text-decoration-none">Find Booking</a></li>
                        <li><a href="{% url 'api:overview' %}" class="text-muted text-decoration-none">API</a></li>
                        <li><a href="#" class="text-muted text-decoration-none">Mobile App</a></li>
                    </ul>
                </div>

                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="mb-3">Connect</h6>
                    <ul class="list-unstyled">
                        <li class="text-muted"><i class="fas fa-envelope me-2" aria-hidden="true"></i>pratap2003singh@gmail.com</li>
                        <li class="text-muted"><i class="fas fa-phone me-2" aria-hidden="true"></i>+91-915-301-4860</li>
                        <li class="text-muted"><i class="fas fa-map-marker-alt me-2" aria-hidden="true"></i>Gangtok, Sikkim</li>
                    </ul>
                </div>

                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="mb-3">Resources</h6>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'core:about' %}" class="text-muted text-decoration-none">About Us</a></li>
                        <li><a href="{% url 'core:contact' %}" class="text-muted text-decoration-none">Get in Touch</a></li>
                        <li><a href="{% url 'core:feedback' %}" class="text-muted text-decoration-none">Feedback</a></li>
                        <li><a href="{% url 'core:resources' %}" class="text-muted text-decoration-none">Resources</a></li>
                    </ul>
                </div>
            </div>

            <hr class="my-4">

            <div class="row align-items-center">
                <div class="col-md-8">
                    <p class="mb-0 text-muted">
                        &copy; 2025 Monastery360. Built for Smart India Hackathon. All rights reserved.
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button id="install-pwa" class="btn btn-outline-light btn-sm d-none">
                        <i class="fas fa-download me-1" aria-hidden="true"></i>Install App
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <!-- Back to top button -->
    <button type="button" class="btn btn-primary btn-floating" id="back-to-top" aria-label="Back to top">
        <i class="fas fa-arrow-up" aria-hidden="true"></i>
    </button>

    <!-- JavaScript Libraries -->
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <!-- Pannellum JS -->
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

    <!-- Custom JavaScript -->
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/geofence.js' %}"></script>

    <!-- Service Worker Registration (robust) -->
    <script>
        (function() {
            if (!('serviceWorker' in navigator)) return;

            // Listen for controller changes (when a new SW takes control)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('ServiceWorker controllerchanged — reloading page to be controlled by new worker');
                try { window.location.reload(true); } catch(e) { window.location.reload(); }
            });

            // Register and try to activate any waiting worker immediately
            navigator.serviceWorker.register('{% url "service_worker" %}', { scope: '/' })
                .then(async reg => {
                    console.log('ServiceWorker registered with scope:', reg.scope);
                    try { await reg.update(); console.log('ServiceWorker update() called'); } catch (e) { console.warn('update() failed', e); }

                    // If there's a waiting worker, ask it to skip waiting (our SW listens for this message)
                    if (reg.waiting) {
                        try {
                            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                            console.log('Sent SKIP_WAITING to waiting worker');
                        } catch (e) { console.warn('postMessage to waiting worker failed', e); }
                    }
                })
                .catch(err => console.warn('ServiceWorker registration failed:', err));
        })();
    </script>

    <!-- Google Translate Integration -->
    <script>
        // Google Translate configuration and functionality
        let googleTranslateLoaded = false;
        let currentLanguage = 'en';

        // Load Google Translate API
        function loadGoogleTranslateAPI() {
            if (googleTranslateLoaded) return Promise.resolve();

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
                script.onerror = reject;
                script.onload = () => {
                    googleTranslateLoaded = true;
                    resolve();
                };
                document.head.appendChild(script);
            });
        }

        // Initialize Google Translate
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,hi,ne',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false,
                multilanguagePage: false
            }, 'google_translate_element');

            // Hide the default Google Translate widget
            setTimeout(() => {
                const widget = document.getElementById('google_translate_element');
                if (widget) {
                    widget.style.display = 'none';
                }

                // Hide Google Translate toolbar if it appears
                const toolbar = document.querySelector('.goog-te-banner-frame');
                if (toolbar) {
                    toolbar.style.display = 'none';
                }

                // Remove top margin added by Google Translate
                document.body.style.marginTop = '0px';
            }, 100);
        }

        // Translate page to specified language
        function translatePage(targetLanguage) {
            if (!googleTranslateLoaded) {
                showTranslationLoading(true);
                loadGoogleTranslateAPI().then(() => {
                    setTimeout(() => {
                        doTranslate(targetLanguage);
                    }, 500);
                }).catch(() => {
                    showTranslationError();
                });
            } else {
                doTranslate(targetLanguage);
            }
        }

        function doTranslate(targetLanguage) {
            const selectElement = document.querySelector('.goog-te-combo');
            if (selectElement) {
                selectElement.value = targetLanguage;
                selectElement.dispatchEvent(new Event('change'));
                currentLanguage = targetLanguage;
                updateCurrentLanguageDisplay();
                showTranslationLoading(false);

                // Store language preference
                localStorage.setItem('preferred_language', targetLanguage);
            } else {
                console.error('Google Translate element not found');
                showTranslationError();
            }
        }

        // Reset translation
        function resetTranslation() {
            const selectElement = document.querySelector('.goog-te-combo');
            if (selectElement) {
                selectElement.value = 'en';
                selectElement.dispatchEvent(new Event('change'));
                currentLanguage = 'en';
                updateCurrentLanguageDisplay();
                localStorage.removeItem('preferred_language');
            }
        }

        // Update the displayed current language
        function updateCurrentLanguageDisplay() {
            const currentLangSpan = document.getElementById('current-language');
            const languageNames = {
                'en': 'English',
                'hi': 'हिन्दी',
                'ne': 'नेपाली'
            };
            if (currentLangSpan) {
                currentLangSpan.textContent = languageNames[currentLanguage] || 'English';
            }
        }

        // Show loading state
        function showTranslationLoading(show) {
            const currentLangSpan = document.getElementById('current-language');
            if (currentLangSpan) {
                if (show) {
                    currentLangSpan.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Translating...';
                } else {
                    updateCurrentLanguageDisplay();
                }
            }
        }

        // Show translation error
        function showTranslationError() {
            const currentLangSpan = document.getElementById('current-language');
            if (currentLangSpan) {
                currentLangSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                setTimeout(updateCurrentLanguageDisplay, 2000);
            }
        }

        // Initialize language switcher
        document.addEventListener('DOMContentLoaded', function() {
            // Create hidden Google Translate element
            const translateDiv = document.createElement('div');
            translateDiv.id = 'google_translate_element';
            translateDiv.style.display = 'none';
            document.body.appendChild(translateDiv);

            // Add event listeners to language options
            document.querySelectorAll('.language-option').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetLang = this.getAttribute('data-lang');
                    translatePage(targetLang);
                });
            });

            // Add event listener to reset button
            document.getElementById('reset-translation').addEventListener('click', function(e) {
                e.preventDefault();
                resetTranslation();
            });

            // Load saved language preference
            const savedLanguage = localStorage.getItem('preferred_language');
            if (savedLanguage && savedLanguage !== 'en') {
                setTimeout(() => {
                    translatePage(savedLanguage);
                }, 1000);
            }

            // Preload Google Translate API
            setTimeout(() => {
                loadGoogleTranslateAPI().catch(console.warn);
            }, 2000);
        });

        // Clean up Google Translate styling issues
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    // Hide Google Translate toolbar
                    const toolbar = document.querySelector('.goog-te-banner-frame');
                    if (toolbar) {
                        toolbar.style.display = 'none';
                        document.body.style.marginTop = '0px';
                    }

                    // Style the translate select dropdown if visible
                    const combo = document.querySelector('.goog-te-combo');
                    if (combo) {
                        combo.style.display = 'none';
                    }
                }
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>

    <!-- Additional JavaScript -->
    {% block extra_js %}{% endblock %}

    <!-- Page-specific React components -->
    {% block react_components %}{% endblock %}
</body>
</html>
