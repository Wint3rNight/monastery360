<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{ page_title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css" />
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-6xl mx-auto p-6">
        <a href="/tours/" class="text-sm text-orange-600 hover:underline">‚Üê Back to Virtual Tours</a>
        <h1 class="text-3xl font-extrabold mt-4 mb-2">{{ monastery.name }}</h1>
        <p class="text-gray-700 mb-6 text-sm leading-relaxed">{{ page_description }}</p>

    <!-- panorama / poi / archives data json for client-side consumption -->
    {{ panorama_data_json|json_script:"panorama-data" }}
    {{ poi_data_json|json_script:"poi-data" }}
    {{ archive_items|json_script:"archive-data" }}

    <!-- Panorama viewer -->
    <div id="panorama" class="w-full h-[60vh] rounded-xl overflow-hidden shadow-2xl"></div>

    <!-- Thumbnails / other panoramas -->
    <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4" id="panorama-thumbs"></div>

        <!-- Audio POIs -->
        <div class="mt-8 bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Audio Points of Interest</h2>
            <div id="poi-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

    <!-- Archives section removed per request -->
    </div>

    <script>
        (function(){
            // Parse JSON data injected via json_script
            const panoramaData = JSON.parse(document.getElementById('panorama-data').textContent || '[]');
            const poiData = JSON.parse(document.getElementById('poi-data').textContent || '[]');
            
            // Load panorama configuration from JSON
            let panoramaConfig = {};
            let monasteryViews = null;
            let currentViewIndex = 0;
            let currentAudio = null;
            
            fetch('/static/data/monastery_panoramas.json')
              .then(response => response.json())
              .then(data => {
                panoramaConfig = data;
                const monasterySlug = "{{ monastery.slug }}";
                
                // Get monastery-specific views
                if (data.monasteries[monasterySlug]) {
                  monasteryViews = data.monasteries[monasterySlug];
                } else {
                  monasteryViews = {
                    name: "{{ monastery.name }}",
                    views: [data.defaultView]
                  };
                }
                
                initializePanorama();
                setupViewNavigation();
                setupViewInfo();
              })
              .catch(err => {
                console.error('Failed to load panorama config:', err);
                initializeFallbackPanorama();
              });

            function initializePanorama() {
              if (!monasteryViews || !monasteryViews.views) return;
              
              const currentView = monasteryViews.views[currentViewIndex];
              
              // Create pannellum viewer
              pannellum.viewer('panorama', {
                type: currentView.type || 'equirectangular',
                panorama: currentView.url,
                autoLoad: true,
                autoRotate: -2,
                showZoomCtrl: true,
                showFullscreenCtrl: true,
                mouseZoom: true,
                draggable: true,
                keyboardZoom: true,
                showControls: true,
                pitch: currentView.pitch || 0,
                yaw: currentView.yaw || 0,
                hfov: currentView.hfov || 110,
                hotSpots: currentView.hotspots || [],
                title: currentView.title
              });
              
              updateViewInfo();
            }
            
            function initializeFallbackPanorama() {
              pannellum.viewer('panorama', {
                type: 'equirectangular',
                panorama: 'https://images.unsplash.com/photo-1544735716-392fe2489ffa?q=80&w=2070&auto=format&fit=crop',
                autoLoad: true,
                autoRotate: -2,
                showZoomCtrl: true,
                showFullscreenCtrl: true
              });
            }

            function setupViewNavigation() {
              if (!monasteryViews || !monasteryViews.views || monasteryViews.views.length <= 1) return;
              
              const navContainer = document.createElement('div');
              navContainer.className = 'view-navigation mb-4';
              navContainer.innerHTML = '<h4 class="text-lg font-medium text-gray-800 mb-3">üèõÔ∏è Areas to Explore:</h4><div class="flex flex-wrap gap-2" id="view-buttons"></div>';
              
              const panoramaElement = document.getElementById('panorama');
              panoramaElement.parentElement.insertBefore(navContainer, panoramaElement);
              
              const buttonsContainer = document.getElementById('view-buttons');
              monasteryViews.views.forEach((view, index) => {
                const button = document.createElement('button');
                button.className = 'px-4 py-2 rounded-lg transition-all duration-200 font-medium ' + 
                  (index === currentViewIndex ? 'bg-orange-500 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300');
                button.textContent = view.title;
                button.onclick = () => switchView(index);
                buttonsContainer.appendChild(button);
              });
            }

            function setupViewInfo() {
              const infoPanel = document.createElement('div');
              infoPanel.id = 'current-view-info';
              infoPanel.className = 'bg-white p-4 rounded-lg shadow-md mb-4';
              
              const panoramaElement = document.getElementById('panorama');
              panoramaElement.parentElement.insertBefore(infoPanel, panoramaElement);
              
              updateViewInfo();
            }

            function switchView(index) {
              if (index === currentViewIndex || !monasteryViews.views[index]) return;
              
              currentViewIndex = index;
              
              // Stop current audio
              if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
              }
              
              // Update button styles
              const buttons = document.querySelectorAll('#view-buttons button');
              buttons.forEach((btn, i) => {
                btn.className = 'px-4 py-2 rounded-lg transition-all duration-200 font-medium ' + 
                  (i === index ? 'bg-orange-500 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300');
              });
              
              initializePanorama();
            }

            function updateViewInfo() {
              const currentView = monasteryViews.views[currentViewIndex];
              if (!currentView) return;
              
              const infoPanel = document.getElementById('current-view-info');
              if (!infoPanel) return;
              
              infoPanel.innerHTML = 
                '<div class="flex items-start justify-between">' +
                  '<div class="flex-1">' +
                    '<h3 class="text-xl font-semibold text-gray-800 mb-2">' + currentView.title + '</h3>' +
                    '<p class="text-gray-600 mb-3">' + (currentView.description || '') + '</p>' +
                  '</div>' +
                  (currentView.audio ? 
                    '<div class="audio-control ml-4">' +
                      '<button id="audio-btn" class="flex items-center space-x-2 px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-all duration-200 font-medium" onclick="toggleAudio()">' +
                        '<i class="fas fa-play"></i>' +
                        '<span>Play Narration' + (currentView.audioDuration ? ' (' + currentView.audioDuration + 's)' : '') + '</span>' +
                      '</button>' +
                    '</div>' : '') +
                '</div>';
            }

            function toggleAudio() {
              const currentView = monasteryViews.views[currentViewIndex];
              const audioBtn = document.getElementById('audio-btn');
              
              if (currentAudio && !currentAudio.paused) {
                // Pause audio
                currentAudio.pause();
                audioBtn.innerHTML = '<i class="fas fa-play"></i><span>Play Narration' + 
                  (currentView.audioDuration ? ' (' + currentView.audioDuration + 's)' : '') + '</span>';
                audioBtn.className = 'flex items-center space-x-2 px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-all duration-200 font-medium';
              } else {
                // Play audio
                if (!currentAudio) {
                  currentAudio = new Audio(currentView.audio);
                  currentAudio.addEventListener('ended', () => {
                    audioBtn.innerHTML = '<i class="fas fa-play"></i><span>Play Narration' + 
                      (currentView.audioDuration ? ' (' + currentView.audioDuration + 's)' : '') + '</span>';
                    audioBtn.className = 'flex items-center space-x-2 px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-all duration-200 font-medium';
                  });
                }
                
                currentAudio.play().then(() => {
                  audioBtn.innerHTML = '<i class="fas fa-pause"></i><span>Pause Narration</span>';
                  audioBtn.className = 'flex items-center space-x-2 px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-all duration-200 font-medium';
                }).catch(err => {
                  console.warn('Audio playback failed:', err);
                });
              }
            }

            function initializePanorama() {
              // Choose first panorama or use monastery-specific panorama
              const monasterySlug = "{{ monastery.slug }}";
              const first = panoramaData && panoramaData.length ? panoramaData[0] : null;
              
              // Get monastery-specific panorama or use first available or fallback
              let imageUrl = null;
              let config = { initial_yaw: 0, initial_pitch: 0, hotspots: [] };
              
              if (first && first.image_url) {
                imageUrl = first.image_url;
                config.initial_yaw = first.initial_yaw || 0;
                config.initial_pitch = first.initial_pitch || 0;
                config.hotspots = first.hotspots_data || [];
              } else if (panoramaConfig[monasterySlug]) {
                const monasteryPano = panoramaConfig[monasterySlug];
                imageUrl = monasteryPano.url;
                config.initial_yaw = monasteryPano.yaw || 0;
                config.initial_pitch = monasteryPano.pitch || 0;
              } else if (panoramaConfig['default']) {
                imageUrl = panoramaConfig['default'].url;
              }

              // Create pannellum viewer instance and keep reference for switching
              let viewer = null;
              function createViewer(imageUrl, config={}){
                const opts = Object.assign({
                  type: 'equirectangular',
                  panorama: imageUrl || 'https://images.unsplash.com/photo-1544735716-392fe2489ffa?q=80&w=2070&auto=format&fit=crop',
                  autoLoad: true,
                  autoRotate: -2,
                  showZoomCtrl: true,
                  showFullscreenCtrl: true,
                  pitch: config.initial_pitch || 0,
                  yaw: config.initial_yaw || 0,
                  hotSpots: config.hotspots || []
                }, config.extra || {});

                // If a viewer already exists, destroy its container then recreate
                if(viewer){
                  try{ viewer.destroy(); } catch(e){}
                }

                viewer = pannellum.viewer('panorama', opts);
                return viewer;
              }

              try{
                createViewer(imageUrl, config);
              } catch (err) {
                console.warn('Panorama init error', err);
                document.getElementById('panorama').innerHTML = '<div class="p-8 text-center text-gray-600">360¬∞ panorama currently unavailable.</div>';
              }
            }

            // thumbnails (switch panorama in-page)
            const thumbs = document.getElementById('panorama-thumbs');
            const monasterySlug = "{{ monastery.slug }}";
            panoramaData.forEach(p => {
                const el = document.createElement('div');
                el.className = 'block bg-white rounded overflow-hidden shadow cursor-pointer';
                el.innerHTML = `
                    <img src="${p.image_url || placeholder}" class="w-full h-36 object-cover" />
                    <div class="p-2 text-sm font-medium text-gray-900">${p.title || 'Panorama'}</div>
                `;

                // click to switch panorama in the viewer
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    // recreate viewer with selected panorama and hotspots
                    createViewer(p.image_url, { initial_yaw: p.initial_yaw, initial_pitch: p.initial_pitch, hotspots: p.hotspots_data });
                });

                // secondary link to open the dedicated panorama detail page
                const linkWrap = document.createElement('a');
                linkWrap.href = p.id ? `/tours/panorama/${monasterySlug}/${p.id}/` : '#';
                linkWrap.appendChild(el);
                thumbs.appendChild(linkWrap);
            });

                        // POI list
            const poiList = document.getElementById('poi-list');
            if(!poiData || !poiData.length){
                poiList.innerHTML = '<div class="text-gray-600">No audio points available.</div>';
            } else {
                poiData.forEach(poi => {
                    const div = document.createElement('div');
                    div.className = 'p-4 bg-white rounded shadow';
                    div.innerHTML = `
                        <h3 class="font-semibold">${poi.title}</h3>
                        <p class="text-sm text-gray-600 mb-2">${poi.description}</p>
                        ${poi.audio_url ? `<audio controls src="${poi.audio_url}" class="w-full"></audio>` : ''}
                    `;
                    poiList.appendChild(div);
                });
            }

                        // Archives rendering removed per request
        })();
    </script>
</body>
</html>
